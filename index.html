<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Integração Stone com SDK Android</title>

    <link href="stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
      <script src="javascripts/all.js" type="text/javascript"></script>

      <script>
        $(function() {
          setupLanguages(["java"]);
        });
      </script>
  </head>

  <body class="index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" />
        <div class="lang-selector">
              <a href="#" data-language-name="java">Java</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduo'>Introdução</h1>
<p>O SDK da Stone para Android oferece uma forma simples e rápida para iniciar sua integração. Com o SDK é possível integrar um dispositivo com bluetooth e Android 2.3 ou superior com o serviço Stone. Para isso, basta importar as bibliotecas <code class="prettyprint">XStream</code> e <code class="prettyprint">sdkstoneapplication.jar</code> em seu projeto.</p>

<p>Você poderá fazer o download do SDK, XStream e do código de exemplo no repositório android-sdk da Stone no Github: <a href="https://github.com/stone-pagamentos/sdk-android">android-sdk</a></p>
<h1 id='integrao'>Integração</h1><h2 id='envio-da-transao'>Envio da transação</h2>
<aside class="warning">O método `sendTransactionToStoneApplication` está obsoleto e será removido em versões futuras</aside>
<pre><code class="highlight java"><span class="nd">@deprecated</span>
<span class="n">StartTransaction</span><span class="o">.</span><span class="na">sendTransactionToStoneApplication</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span>
                                                   <span class="n">amount</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                                                   <span class="n">getChecked</span><span class="o">(),</span>
                                                   <span class="n">numberOfParcel</span><span class="o">,</span>
                                                   <span class="n">parcelType</span><span class="o">,</span>
                                                   <span class="n">demand</span><span class="o">,</span>
                                                   <span class="n">autoFlagCheckedTextView</span><span class="o">.</span><span class="na">isChecked</span><span class="o">()</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="o">,</span>
                                                   <span class="n">R</span><span class="o">.</span><span class="na">anim</span><span class="o">.</span><span class="na">fade_in</span><span class="o">,</span>
                                                   <span class="n">R</span><span class="o">.</span><span class="na">anim</span><span class="o">.</span><span class="na">fade_out</span> <span class="o">);</span>
</code></pre>
<pre><code class="highlight java"><span class="n">StartTransaction</span><span class="o">.</span><span class="na">startNewTransaction</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">mTransaction</span><span class="o">,</span> <span class="n">animStart</span><span class="o">,</span> <span class="n">animEnd</span><span class="o">);</span>
</code></pre>

<p>O usuário terá uma transação de interface que o levará da sua aplicação para a aplicação da Stone. O SDK faz a comunicação com o aplicativo <a href="https://play.google.com/store/apps/details?id=br.com.stone">Stone Mobile</a> que, por sua vez, se comunica com o PINPad. O aplicativo está encarregado de avisar quando há ou não uma conexão com algum PINpad. Se o usuário não estiver conectado com nenhum dispositivo, o aplicativo exibirá um botão para buscar e conectar com algum dispositivo.</p>

<p>A conexão com o PINpad pode ser criada automaticamente após a primeira conexão. Para essa função ser habilitada, é necessário ir em CONFIGURAÇÕES, localizada na aba lateral e selecionar a opção de ‘Conexão automática’.</p>

<p>Quando esta opção está marcada, um serviço é ativado. Esse serviço é responsável por verificar a conexão com o PINpad a cada 5 minutos. Se nenhum PINpad estiver conectado com o dispositivo, o mesmo tentará criar conexão com o último PINpad conectado com o dispositivo.</p>

<aside class="warning">
OBS: Lembrando que se o aplicativo da Stone for fechado, a conexão será interrompida por alguns segundos, e se a opção de ‘Conexão automática’ estiver marcada, dentro de alguns segundos e conexão irá o serviço será ativado e irá conectar com o PINpad. 
</aside>
<h2 id='retorno-da-transao'>Retorno da transação</h2><pre><code class="highlight java"><span class="n">String</span> <span class="n">xmlTransaction</span>  <span class="o">=</span> <span class="n">backActivity</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"xmlTransaction"</span><span class="o">);</span>
<span class="n">ReturnOfTransactionXml</span> <span class="n">mReturnOfTransactionXml</span><span class="o">;</span>
<span class="n">mReturnOfTransactionXml</span> <span class="o">=</span> <span class="n">TransactionResponse</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">xmlTransaction</span><span class="o">,</span> <span class="n">backActivity</span><span class="o">);</span>

<span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"sdk_stone"</span><span class="o">,</span>
        <span class="s">"\n\n======== Dados recebidos SDK ========"</span>
        <span class="o">+</span> <span class="s">"\nValor               : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">amount</span>
        <span class="o">+</span> <span class="s">"\nARN                 : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">arn</span>
        <span class="o">+</span> <span class="s">"\nParcelas            : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">parcel</span>
        <span class="o">+</span> <span class="s">"\nBandeira            : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">flag</span>
        <span class="o">+</span> <span class="s">"\nCA                  : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">ca</span>
        <span class="o">+</span> <span class="s">"\nStatus              : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">status</span>
        <span class="o">+</span> <span class="s">"\nData                : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">date</span>
        <span class="o">+</span> <span class="s">"\nAmountOfInst.       : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">amountOfInstallments</span>
        <span class="o">+</span> <span class="s">"\nDemandId            : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">demandId</span>
        <span class="o">+</span> <span class="s">"\nTipo da transação   : "</span> <span class="o">+</span> <span class="n">mReturnOfTransactionXml</span><span class="o">.</span><span class="na">transactionType</span><span class="o">);</span>
</code></pre>

<p>Quando o autorizador da Stone responder a transação, aprovada ou negada, o aplicativo da Stone irá retornar para o aplicativo que o chamou e enviará algumas informações que foram recebidas do autorizador.</p>

<p>O método getExternalInformations() fica responsável por verificar se há ou não um retorno de transação. É aconselhável que ele fique no método “onResume()” da main do seu projeto. O aplicativo da Stone retornará um XML contendo as informações da transação: <code class="prettyprint">getIntent().getExtras().getString(&quot;xmlTransaction&quot;)</code></p>
<h1 id='classes'>Classes</h1>
<table><thead>
<tr>
<th>Nome</th>
<th>Descrição</th>
</tr>
</thead><tbody>
<tr>
<td>StartTransaction</td>
<td>Essa classe envia uma transação para o aplicativo Stone Mobile.</td>
</tr>
<tr>
<td>StartTypedTransaction</td>
<td>Essa classe envia uma transação digitada para o aplicativo Stone Mobile.</td>
</tr>
<tr>
<td>StartCancellation</td>
<td>Essa classe permite o cancelamento de transações</td>
</tr>
</tbody></table>
<h2 id='starttransaction'>StartTransaction</h2>
<p>Essa classe envia uma transação para o aplicativo Stone Mobile.</p>

<p><code class="prettyprint">void StartTransaction.startNewTransaction(Activity activity, Transaction transaction, Integer animStart, Integer animEnd);</code></p>
<pre><code class="highlight java"><span class="n">StartTransaction</span><span class="o">.</span><span class="na">startNewTransaction</span><span class="o">(</span><span class="k">this</span><span class="o">,</span>
                                     <span class="n">mTransaction</span><span class="o">,</span>
                                     <span class="n">animStart</span><span class="o">,</span>
                                     <span class="n">animEnd</span><span class="o">);</span>
</code></pre>

<table><thead>
<tr>
<th>Tipo</th>
<th>Parâmetro</th>
<th>Descrição</th>
</tr>
</thead><tbody>
<tr>
<td>Context</td>
<td>context</td>
<td>Contexto da aplicação</td>
</tr>
<tr>
<td>Transaction</td>
<td>Transaction</td>
<td>Dados da transação</td>
</tr>
<tr>
<td>Integer</td>
<td>animStart</td>
<td>Animação inicial</td>
</tr>
<tr>
<td>Integer</td>
<td>animEnd</td>
<td>Animação final</td>
</tr>
</tbody></table>
<h3 id='transaction'>Transaction</h3>
<table><thead>
<tr>
<th>Método</th>
<th>Descrição</th>
</tr>
</thead><tbody>
<tr>
<td>setAmount(String amount)</td>
<td>Define o valor da transação</td>
</tr>
<tr>
<td>setTypeOfPurchase(Integer typeOfPurchase)</td>
<td>Tipo da compra (1- débito ou 2 - crédito )</td>
</tr>
<tr>
<td>setTypeOfInstalment(Integer typeParcels)</td>
<td>Tipo de parcela (0 -  à vista ou 1 - parcelamento)</td>
</tr>
<tr>
<td>setNumberOfInstalments(Integer numberOfInstalments)</td>
<td>Número de parcelas da transação</td>
</tr>
<tr>
<td>setDemandId(Integer demandId)</td>
<td>Uma numeração para a transação</td>
</tr>
<tr>
<td>setNeededConfirm(boolean isNeededConfirm)</td>
<td>Confirmação das informações pelo usuário</td>
</tr>
</tbody></table>
<h2 id='starttypedtransaction'>StartTypedTransaction</h2>
<p>Essa classe envia uma transação digitada para o aplicativo Stone Mobile</p>

<p><code class="prettyprint">void StartTypedTransaction.sendTypedTransactionToStoneApplication(Context context, String amount, String PAN, String CVV, String date, Integer numberOfParcels, Integer typeParcels)</code></p>
<pre><code class="highlight java"><span class="n">StartTransaction</span><span class="o">.</span><span class="na">sendTypedTransactionToStoneApplication</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span>     <span class="c1">// contexto</span>
                                                        <span class="n">amount</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="c1">// valor em centavos</span>
                                                        <span class="n">pan</span><span class="o">,</span>                         <span class="c1">// número do cartão</span>
                                                        <span class="n">cvv</span><span class="o">,</span>                         <span class="c1">// CVV</span>
                                                        <span class="n">date</span><span class="o">,</span>                        <span class="c1">// expiração</span>
                                                        <span class="n">numberOfParcel</span><span class="o">,</span>              <span class="c1">// número de parcelas</span>
                                                        <span class="n">parcelType</span><span class="o">);</span>                 <span class="c1">// tipo de parcelas</span>
</code></pre>

<table><thead>
<tr>
<th>Tipo</th>
<th>Parâmetro</th>
<th>Descrição</th>
</tr>
</thead><tbody>
<tr>
<td>Context</td>
<td>context</td>
<td>Contexto da aplicação</td>
</tr>
<tr>
<td>String</td>
<td>amount</td>
<td>Valor da transação <strong>em centavos</strong></td>
</tr>
<tr>
<td>String</td>
<td>PAN</td>
<td>Número do cartão do cliente</td>
</tr>
<tr>
<td>String</td>
<td>CVV</td>
<td>Código de segurança do verso do cartão</td>
</tr>
<tr>
<td>String</td>
<td>date</td>
<td>Data de expiração do cartão</td>
</tr>
<tr>
<td>Integer</td>
<td>numberOfParcels</td>
<td>Número de parcelas (se houve parcerlamento)</td>
</tr>
<tr>
<td>Integer</td>
<td>typeOfParcels</td>
<td>Tipo de parcela (0 - à vista, 1 - lojista, 2 - emissor</td>
</tr>
</tbody></table>
<h2 id='startcancellation'>StartCancellation</h2>
<p>Essa classe permite o cancelamento de transações</p>

<p><code class="prettyprint">void StartCancellation.sendCancellationToStoneApplication(Context context, String arn, String ca)</code></p>
<pre><code class="highlight java"><span class="n">StartCancellation</span><span class="o">.</span><span class="na">sendCancellationToStoneApplication</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span> <span class="c1">// contexto</span>
                                                     <span class="n">arn</span><span class="o">,</span>                     <span class="c1">// Numeração da transação</span>
                                                     <span class="n">ca</span><span class="o">);</span>                     <span class="c1">// Código da transação</span>
</code></pre>

<table><thead>
<tr>
<th>Tipo</th>
<th>Parâmetro</th>
<th>Descrição</th>
</tr>
</thead><tbody>
<tr>
<td>Context</td>
<td>context</td>
<td>Contexto da aplicação</td>
</tr>
<tr>
<td>String</td>
<td>arn</td>
<td>Numeração da transação</td>
</tr>
<tr>
<td>String</td>
<td>ca</td>
<td>Código da transação</td>
</tr>
</tbody></table>
<h2 id='transactionresponse'>TransactionResponse</h2>
<p><code class="prettyprint">ReturnOfTransactionXml getTransaction(Activity activity, String xmlReceive, Bundle backActivity)</code></p>
<pre><code class="highlight java"><span class="n">mReturnOfTransactionXml</span> <span class="o">=</span> <span class="n">TransactionResponse</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="n">xmlTransaction</span><span class="o">,</span><span class="n">backActivity</span><span class="o">);</span>
</code></pre>

<table><thead>
<tr>
<th>Tipo</th>
<th>Parâmetro</th>
<th>Descrição</th>
</tr>
</thead><tbody>
<tr>
<td>Activity</td>
<td>activity</td>
<td>Contexto da aplicação</td>
</tr>
<tr>
<td>String</td>
<td>xmlReceive</td>
<td>A String ‘xml’ recebe uma String contida na variável ‘backActivity’. A mesma deve ser passada, apenas.</td>
</tr>
<tr>
<td>Bundle</td>
<td>backActivity</td>
<td>O retorno da Intent</td>
</tr>
</tbody></table>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="java">Java</a>
          </div>
      </div>
    </div>
  </body>
</html>
